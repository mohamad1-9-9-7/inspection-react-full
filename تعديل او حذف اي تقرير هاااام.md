
# دليل تعديل/حذف تقرير على السيرفر (Open-CRUD)

**آخر تحديث:** 2025-08-17 19:08 UTC

## الأساسيات
- **API_BASE:** `https://inspection-server-4nvj.onrender.com`
- **الهيدر:** كل الطلبات ترسل JSON مع: `Content-Type: application/json`
- **أكواد الاستجابة**  
  - `200` نجاح (قراءة/تعديل)  
  - `201` تمت الإضافة  
  - `400` بيانات ناقصة/صيغة خاطئة  
  - `404` غير موجود  
  - `500` خطأ سيرفر

---

## نقاط فحص سريعة (اختياري)
- **GET** `/` → يعيد "OK"
- **GET** `/healthz` → يتأكد من اتصال قاعدة البيانات
- **GET** `/version` → رقم نسخة الـ API

---

## 1) قراءة التقارير (معرفة الـ id أو التأكد من التاريخ)

**قائمة تقارير نوع returns (أحدث أولًا):**
```bash
curl -s "{{API_BASE}}/api/reports?type=returns"
```

> الاستجابة: كائن يحتوي `ok: true` و`data: [...]`، وكل سجل فيه حقول منها: `id`, `type`, `payload` (وفي داخلها `reportDate`, `items`), `created_at`, `updated_at`.

---

## 2) تعديل/حفظ تقرير يوم (UPSERT) حسب (type + reportDate)

> يستخدم مسار واحد فقط ويحدّث إن وجد أو يضيف إن لم يوجد.

**PUT** `/api/reports`
```bash
curl -X PUT "https://inspection-server-4nvj.onrender.com/api/reports"   -H "Content-Type: application/json"   -d '{
    "reporter": "anonymous",
    "type": "returns",
    "payload": {
      "reportDate": "2025-08-17",
      "items": [
        {
          "productName": "Item A",
          "origin": "UAE",
          "butchery": "Main",
          "quantity": 3,
          "qtyType": "kg",
          "expiry": "2025-09-01",
          "remarks": "ok",
          "action": "Use in kitchen"
        }
      ]
    }
  }'
```

**مهم:** الحقلان الإلزاميان هنا:
- `type` (مثلاً `"returns"`)
- `payload.reportDate` بصيغة `YYYY-MM-DD`

---

## 3) تعديل تقرير حسب الـ ID (اختياري)

> تحتاج `id` من نتيجة القراءة.

**PUT** `/api/reports/:id`
```bash
curl -X PUT "https://inspection-server-4nvj.onrender.com/api/reports/123"   -H "Content-Type: application/json"   -d '{
    "payload": { "reportDate": "2025-08-17", "items": [] }
  }'
```
يمكنك إرسال أي من: `payload` أو `reporter` أو `type` (واحد على الأقل) — وإلا ستظهر 400 **"nothing to update"**.

---

## 4) حذف تقرير يوم معيّن (بالنوع + التاريخ)

**DELETE** `/api/reports?type=returns&reportDate=YYYY-MM-DD`
```bash
curl -X DELETE "https://inspection-server-4nvj.onrender.com/api/reports?type=returns&reportDate=2025-08-17"
```

---

## 5) حذف تقرير بالـ ID

**DELETE** `/api/reports/:id`
```bash
curl -X DELETE "https://inspection-server-4nvj.onrender.com/api/reports/123"
```

---

## أمثلة سريعة بـ `fetch` (واجهة/Node)

```js
const API_BASE = "https://inspection-server-4nvj.onrender.com";

// تعديل/حفظ تقرير يوم (UPSERT)
async function saveReturn(reportDate, items, reporter = "anonymous") {
  const res = await fetch(`${API_BASE}/api/reports`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      reporter,
      type: "returns",
      payload: { reportDate, items }
    })
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

// حذف تقرير يوم معيّن
async function deleteReturnByDate(reportDate) {
  const res = await fetch(`${API_BASE}/api/reports?type=returns&reportDate=${encodeURIComponent(reportDate)}`, {
    method: "DELETE"
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

// حذف تقرير بالـ ID
async function deleteReportById(id) {
  const res = await fetch(`${API_BASE}/api/reports/${id}`, { method: "DELETE" });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}
```

---

## حلول الأخطاء الشائعة
- **500** فيه `updated_at` → اعمل ترقية للسكيمة (صار محلول بخدمة السيرفر الحالية؛ أنشأ العمود تلقائيًا).
- **400 "type & payload.reportDate required"** → لازم ترسل `type` وداخل `payload` تاريخ `reportDate`.
- **"nothing to update"** في `/api/reports/:id` → لازم ترسل واحد على الأقل من `payload` أو `reporter` أو `type`.
