// src/pages/QCSRawMaterialInspection.jsx
import React, { useState, useEffect, useRef } from "react";
import { useNavigate } from "react-router-dom";

/* =============================================================================
   üîó API Base (ÿÆÿßÿ±ÿ¨Ÿä ŸÅŸÇÿ∑) ‚Äî ÿ®ÿØŸàŸÜ import.meta ŸÜŸáÿßÿ¶ŸäÿßŸã
   - ŸäŸÇÿ±ÿ£ ÿ£ŸàŸÑÿßŸã window.__QCS_API__ ÿ•ŸÜ ŸàŸèÿ¨ÿØÿå ÿ£Ÿà REACT_APP_API_URLÿå Ÿàÿ•ŸÑÿß ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä.
   - ŸÉŸÑ ÿßŸÑÿ≠ŸÅÿ∏ Ÿäÿ™ŸÖ ÿπŸÑŸâ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä ŸÅŸÇÿ∑ (ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£Ÿä ÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿ≠ŸÑŸä).
============================================================================= */
const API_ROOT_DEFAULT = "https://inspection-server-4nvj.onrender.com";
const API_ROOT =
  (typeof window !== "undefined" && window.__QCS_API__) ||
  (typeof process !== "undefined" && process.env && process.env.REACT_APP_API_URL) ||
  API_ROOT_DEFAULT;

const API_BASE = String(API_ROOT).replace(/\/$/, "");
const REPORTS_URL = `${API_BASE}/api/reports`;

// ŸÑŸà ŸÉÿßŸÜ ŸÜŸÅÿ≥ ÿßŸÑŸÄ origin ÿ±ÿ≠ ŸÜÿ±ÿ≥ŸÑ ÿßŸÑŸÉŸàŸÉŸäÿ≤ÿå ÿ∫Ÿäÿ± ŸáŸäŸÉ ŸÑÿß
const IS_SAME_ORIGIN = (() => {
  try {
    return new URL(API_BASE).origin === window.location.origin;
  } catch {
    return false;
  }
})();

/* =============================================================================
   ‚úâÔ∏è ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ± Ÿàÿßÿ≠ÿØ ŸÑŸÑÿ≥Ÿäÿ±ŸÅÿ± (ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿ¨ÿØŸäÿØ ŸÅŸä ŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±)
   - ŸÜÿ≥ÿ™ÿÆÿØŸÖ POST ŸÅŸÇÿ∑ ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ™ŸÇÿ±Ÿäÿ± ÿ¨ÿØŸäÿØ ŸÖŸÜ ŸÜŸàÿπ qcs_raw_material
   - ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£Ÿä upsert ŸÖÿ≠ŸÑŸä ÿ£Ÿà ÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿ≠ŸÑŸä
============================================================================= */
function getReporter() {
  try {
    const raw = localStorage.getItem("currentUser");
    const user = raw ? JSON.parse(raw) : null;
    return user?.username || "anonymous";
  } catch {
    return "anonymous";
  }
}

// UUID ŸÖÿ®ÿ≥Ÿëÿ∑ ŸÑÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ∑ŸÑÿ® (ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™ŸÉÿ±ÿßÿ±)
const makeClientId = () =>
  `cli_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;

async function sendToServer(payload) {
  const reporter = getReporter();

  const res = await fetch(REPORTS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json", Accept: "application/json" },
    credentials: IS_SAME_ORIGIN ? "include" : "omit",
    body: JSON.stringify({ reporter, type: "qcs_raw_material", payload }),
  });

  if (!res.ok) {
    const t = await res.text().catch(() => "");
    throw new Error(t || `Server error ${res.status}`);
  }
  return res.json().catch(() => ({}));
}

// ŸÅÿ≠ÿµ ŸÖÿ≥ÿ®ŸÇ ŸÑÿπÿØŸÖ ÿ™ŸÉÿ±ÿßÿ± Air Way Bill (ÿ•ŸÜ Ÿàÿ¨ÿØ)
async function checkDuplicateAirway(airwayBill) {
  if (!airwayBill) return false;
  try {
    const q = `${REPORTS_URL}?type=qcs_raw_material`;
    const res = await fetch(q, {
      cache: "no-store",
      mode: "cors",
      credentials: IS_SAME_ORIGIN ? "include" : "omit",
      headers: { Accept: "application/json" },
    });
    if (!res.ok) return false;
    const json = await res.json();
    const arr = Array.isArray(json) ? json : json?.data || [];
    const norm = (s) => String(s || "").trim().toLowerCase();
    return arr.some((rec) => norm(rec?.payload?.generalInfo?.airwayBill) === norm(airwayBill));
  } catch {
    return false;
  }
}

/* =============================================================================
   ‚úÖ ŸáŸäŸÉŸÑ ÿßŸÑÿπŸäŸÜÿ© ÿßŸÑŸÅÿßÿ±ÿ∫ÿ© + ŸÖŸèŸÜÿ¥ÿ¶
============================================================================= */
const initialSample = {
  temperature: "",
  ph: "",
  slaughterDate: "",
  expiryDate: "",
  broken: "",
  appearance: "",
  bloodClots: "",
  colour: "",
  fatDiscoloration: "",
  meatDamage: "",
  foreignMatter: "",
  texture: "",
  testicles: "",
  smell: "",
};
const newEmptySample = () => ({ ...initialSample });

/* =============================================================================
   üé® ÿ£ŸÜŸÖÿßÿ∑ Ÿàÿßÿ¨Ÿáÿ© ÿπÿµÿ±Ÿäÿ© ŸàÿÆŸÅŸäŸÅÿ© ‚Äî (ÿ®ÿØŸàŸÜ ÿÆŸÑÿ∑ shorthand/longhand ŸÑŸÑÿ≠ÿØŸàÿØ)
============================================================================= */
const styles = {
  page: {
    minHeight: "100vh",
    background: "linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%)",
    padding: "32px 16px",
  },
  container: {
    padding: "2rem",
    background: "#fff",
    borderRadius: "16px",
    margin: "0 auto",
    width: "min(1200px, 96vw)",
    direction: "rtl",
    fontFamily: "Cairo, system-ui, -apple-system, Segoe UI, Roboto, sans-serif",
    boxShadow:
      "0 10px 20px rgba(2, 6, 23, 0.06), 0 1px 2px rgba(2, 6, 23, 0.04)",
    border: "1px solid #e5e7eb",
  },
  titleWrap: {
    display: "flex",
    alignItems: "center",
    justifyContent: "space-between",
    gap: "1rem",
    marginBottom: "1.2rem",
  },
  title: {
    color: "#0f172a",
    margin: 0,
    fontSize: "1.5rem",
    fontWeight: 800,
    letterSpacing: "0.2px",
  },
  badge: {
    fontSize: "0.85rem",
    background: "#eef2ff",
    color: "#3730a3",
    padding: "6px 10px",
    borderRadius: "999px",
    border: "1px solid #c7d2fe",
    fontWeight: 700,
  },
  section: { marginBottom: "1.25rem" },
  label: { fontWeight: 700, color: "#0f172a" },

  input: {
    width: "100%",
    padding: "12px 14px",
    borderWidth: 1,
    borderStyle: "solid",
    borderColor: "#bfdbfe",
    borderRadius: "12px",
    outline: "none",
    transition:
      "box-shadow .15s ease, border-color .15s ease, transform .08s ease",
    background: "#fff",
  },
  select: {
    width: "100%",
    padding: "12px 14px",
    borderWidth: 1,
    borderStyle: "solid",
    borderColor: "#bfdbfe",
    borderRadius: "12px",
    outline: "none",
    transition:
      "box-shadow .15s ease, border-color .15s ease, transform .08s ease",
    background: "#fff",
  },
  focused: {
    boxShadow: "0 0 0 4px rgba(59,130,246,.25)",
    borderColor: "#3b82f6",
    transform: "translateY(-1px)",
  },

  fieldset: {
    marginBottom: "1.5rem",
    padding: "1.25rem",
    border: "1px solid #e5e7eb",
    borderRadius: "14px",
    background: "#fafafa",
  },
  legend: {
    fontWeight: 800,
    fontSize: "1.05rem",
    color: "#111827",
    padding: "0 .4rem",
  },
  grid: {
    display: "grid",
    gridTemplateColumns: "repeat(auto-fit, minmax(260px, 1fr))",
    gap: "12px",
    marginTop: "12px",
  },
  row: { display: "flex", flexDirection: "column", gap: "6px" },
  statusContainer: {
    display: "flex",
    alignItems: "center",
    gap: "0.75rem",
    marginTop: "0.5rem",
    flexWrap: "wrap",
  },
  tableWrap: {
    overflowX: "auto",
    background: "#fff",
    border: "1px solid #e5e7eb",
    borderRadius: "12px",
  },
  table: { width: "100%", borderCollapse: "collapse", fontSize: "0.95rem" },
  th: {
    backgroundColor: "#f3f4f6",
    textAlign: "center",
    position: "sticky",
    top: 0,
    zIndex: 1,
    borderBottom: "1px solid #e5e7eb",
    padding: "10px 6px",
    whiteSpace: "nowrap",
  },
  td: { borderTop: "1px solid #f1f5f9", padding: "8px 6px" },
  tdInput: {
    width: "100%",
    minWidth: "120px",
    padding: "10px 12px",
    borderWidth: 1,
    borderStyle: "solid",
    borderColor: "#bfdbfe",
    borderRadius: "10px",
    outline: "none",
    transition: "box-shadow .15s ease, border-color .15s ease",
    background: "#fff",
  },

  actionsRow: {
    display: "flex",
    gap: "12px",
    flexWrap: "wrap",
    marginTop: "1rem",
  },
  addButton: {
    padding: "10px 16px",
    background: "#4f46e5",
    color: "#fff",
    border: "none",
    borderRadius: "10px",
    cursor: "pointer",
    fontWeight: 700,
  },
  uploadButton: {
    padding: "10px 16px",
    background: "#f59e0b",
    color: "#fff",
    border: "none",
    borderRadius: "10px",
    cursor: "pointer",
    marginBottom: "0.75rem",
    fontWeight: 700,
  },
  previewImage: { maxWidth: "200px", marginTop: "0.5rem", borderRadius: "8px" },
  formRow3: {
    display: "grid",
    gridTemplateColumns: "repeat(auto-fit, minmax(240px, 1fr))",
    gap: "12px",
    marginTop: "1rem",
  },
  saveButton: {
    padding: "12px 22px",
    background: "#16a34a",
    color: "#fff",
    border: "none",
    borderRadius: "12px",
    cursor: "pointer",
    fontWeight: 800,
  },
  saveButtonDisabled: {
    opacity: 0.6,
    cursor: "not-allowed",
  },
  viewButton: {
    padding: "12px 22px",
    background: "#2563eb",
    color: "#fff",
    border: "none",
    borderRadius: "12px",
    cursor: "pointer",
    marginTop: "0.75rem",
    fontWeight: 800,
  },
  headerWrap: { marginBottom: "12px" },
  headerTable: {
    width: "100%",
    borderCollapse: "collapse",
    tableLayout: "fixed",
    fontSize: "0.95rem",
    background: "#fff",
    border: "1px solid #e5e7eb",
    borderRadius: "12px",
    overflow: "hidden",
  },
  headerTh: {
    border: "1px solid #e5e7eb",
    background: "#f8fafc",
    textAlign: "right",
    padding: "10px 12px",
    width: "220px",
    color: "#111827",
    fontWeight: 800,
  },
  headerTd: {
    border: "1px solid #e5e7eb",
    padding: "10px 12px",
    background: "#fff",
  },
  headerInput: {
    width: "100%",
    padding: "10px 12px",
    border: "1px solid #e5e7eb",
    borderRadius: 10,
    outline: "none",
  },
  headerRowSpacer: { borderLeft: "1px solid #e5e7eb", width: "10px" },

  // Toast
  toastWrap: {
    position: "fixed",
    left: 16,
    bottom: 16,
    zIndex: 1000,
    maxWidth: "92vw",
  },
  toast: {
    padding: "10px 14px",
    borderRadius: 12,
    boxShadow: "0 6px 16px rgba(0,0,0,.15)",
    fontWeight: 800,
    borderWidth: 1,
    borderStyle: "solid",
  },
};

/* =============================================================================
   üëá ÿßŸÑŸÖŸÉŸàŸëŸÜ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
============================================================================= */
export default function QCSRawMaterialInspection() {
  const navigate = useNavigate();
  const fileInputRef = useRef(null);

  // ÿ±ÿ≥ÿßŸÑÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ŸÅÿ∏ (ÿ≥ÿ±Ÿäÿπÿ© ÿ£ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©)
  const [saveMsg, setSaveMsg] = useState("");

  // Toast ÿ≥ŸÅŸÑŸä ŸÑŸÜÿ¨ÿßÿ≠/ŸÅÿ¥ŸÑ
  const [toast, setToast] = useState({ type: null, msg: "" });

  // ŸÖÿßŸÜÿπ ŸÜŸÇÿ± ŸÖÿ≤ÿØŸàÿ¨
  const [isSaving, setIsSaving] = useState(false);

  // ÿ™ÿ±ŸàŸäÿ≥ÿ© ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿπÿØŸäŸÑ (ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©/ÿßŸÑÿπÿ±ÿ∂)
  const [docMeta, setDocMeta] = useState({
    documentTitle: "Raw Material Inspection Report Chilled lamb",
    documentNo: "FS-QM/REC/RMB",
    issueDate: "2020-02-10",
    revisionNo: "0",
    area: "QA",
  });

  // ‚úÖ ÿßŸÑÿ≠ŸÇŸàŸÑ ŸàÿßŸÑÿ≠ÿßŸÑÿßÿ™
  const [samples, setSamples] = useState([newEmptySample()]);
  const [shipmentType, setShipmentType] = useState("");
  const [shipmentStatus, setShipmentStatus] = useState("ŸÖÿ±ÿ∂Ÿä");
  const [inspectedBy, setInspectedBy] = useState("");
  const [verifiedBy, setVerifiedBy] = useState("");
  const [totalQuantity, setTotalQuantity] = useState("");
  const [totalWeight, setTotalWeight] = useState("");
  const [averageWeight, setAverageWeight] = useState("0");
  const [isFocused, setIsFocused] = useState(null);
  const [generalInfo, setGeneralInfo] = useState({
    reportOn: "",
    receivedOn: "",
    inspectionDate: "",
    temperature: "",
    brand: "",
    invoiceNo: "",
    ph: "",
    origin: "",
    airwayBill: "",
    localLogger: "",
    internationalLogger: "",
  });
  const [certificateFile, setCertificateFile] = useState(null);
  const [certificateName, setCertificateName] = useState("");
  const [notes, setNotes] = useState("");

  // üî¢ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸàÿ≤ŸÜ (ÿØŸäŸÜÿßŸÖŸäŸÉŸä)
  useEffect(() => {
    const q = parseFloat(totalQuantity);
    const w = parseFloat(totalWeight);
    setAverageWeight(q > 0 && w > 0 ? (w / q).toFixed(3) : "0");
  }, [totalQuantity, totalWeight]);

  // ‚úèÔ∏è Handlers
  const handleSampleChange = (index, field, value) => {
    setSamples((prev) =>
      prev.map((s, i) => (i === index ? { ...s, [field]: value } : s))
    );
  };
  const handleGeneralChange = (field, value) => {
    setGeneralInfo((prev) => ({ ...prev, [field]: value }));
  };
  const addSample = () => setSamples((prev) => [...prev, newEmptySample()]);

  const handleCertificateUpload = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onloadend = () => setCertificateFile(String(reader.result || ""));
    reader.readAsDataURL(file);
    setCertificateName(file.name);
  };
  const triggerFileSelect = () => fileInputRef.current?.click();

  /* ========================= üß© ÿ®ŸÜÿßÿ° ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸÖŸÜ ÿßŸÑÿ≠ÿßŸÑÿ© ========================= */
  const buildReportPayload = () => ({
    // ŸÑÿß ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿä ÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿ≠ŸÑŸä ‚Äî Ÿáÿ∞ÿß ŸÖÿ¨ÿ±ÿØ payload ŸäŸèÿ±ÿ≥ŸÑ ŸÑŸÑÿ≥Ÿäÿ±ŸÅÿ±
    clientId: makeClientId(), // Ÿäÿ≥ÿßÿπÿØ ÿπŸÑŸâ ŸÖŸÜÿπ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ŸÅŸä ÿ≠ÿßŸÑ ÿ∂ÿ∫ÿ∑ÿ© ŸÖÿ≤ÿØŸàÿ¨ÿ©
    date: new Date().toISOString(),
    shipmentType,
    status: shipmentStatus,
    generalInfo,
    samples,
    inspectedBy,
    verifiedBy,
    totalQuantity,
    totalWeight,
    averageWeight,
    certificateFile, // DataURL (ÿµŸàÿ±ÿ©/PDF) ÿ•ŸÜ ÿ™ŸÖ ÿ±ŸÅÿπŸá
    certificateName,
    docMeta,
    notes,
  });

  /* ========================= üîî Toast helper ========================= */
  const showToast = (type, msg) => {
    setToast({ type, msg });
    window.clearTimeout(showToast._t);
    showToast._t = window.setTimeout(() => setToast({ type: null, msg: "" }), 3000);
  };

  const toastColors = (type) => {
    switch (type) {
      case "success":
        return { bg: "#ecfdf5", fg: "#065f46", bd: "#34d399" };
      case "error":
        return { bg: "#fef2f2", fg: "#991b1b", bd: "#fca5a5" };
      case "info":
      default:
        return { bg: "#eff6ff", fg: "#1e3a8a", bd: "#93c5fd" };
    }
  };

  /* ========================= üíæ ÿ≠ŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä ŸÅŸÇÿ∑ ========================= */
  const handleSave = async () => {
    if (isSaving) return; // ŸÖŸÜÿπ ÿßŸÑŸÜŸÇÿ±ÿßÿ™ ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©
    if (!shipmentType.trim()) {
      alert("üì¶ ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸàÿπ ÿßŸÑÿ¥ÿ≠ŸÜÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏.");
      return;
    }

    // ŸÑŸà ŸÅŸä Air Way Bill ÿßŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ÿ£ŸàŸÑÿßŸã
    const airway = (generalInfo.airwayBill || "").trim();
    if (airway) {
      const exists = await checkDuplicateAirway(airway);
      if (exists) {
        showToast("error", "‚ùå ŸäŸàÿ¨ÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿ≥ÿßÿ®ŸÇ ÿ®ŸÜŸÅÿ≥ ÿ±ŸÇŸÖ ÿ®ŸàŸÑŸäÿµÿ© ÿßŸÑÿ¥ÿ≠ŸÜ.");
        setSaveMsg("‚ùå ŸäŸàÿ¨ÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜŸÅÿ≥ ÿ±ŸÇŸÖ ÿ®ŸàŸÑŸäÿµÿ© ÿßŸÑÿ¥ÿ≠ŸÜ.");
        return;
      }
    }

    // ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ£ŸÉŸäÿØ ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏
    const ok = window.confirm("ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿü");
    if (!ok) {
      setSaveMsg("‚ÑπÔ∏è ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ŸÅÿ∏.");
      showToast("info", "ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ŸÅÿ∏.");
      return;
    }

    const payload = buildReportPayload();
    try {
      setIsSaving(true);
      setSaveMsg("‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±‚Ä¶");
      showToast("info", "‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏‚Ä¶");
      await sendToServer(payload); // POST /api/reports
      setSaveMsg("‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ÿ®ŸÜÿ¨ÿßÿ≠!");
      showToast("success", "ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ");
    } catch (e) {
      const msg = `‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏: ${e?.message || e}`;
      setSaveMsg(msg);
      showToast("error", msg);
    } finally {
      setIsSaving(false);
      window.clearTimeout(handleSave._t);
      handleSave._t = window.setTimeout(() => setSaveMsg(""), 3000);
    }
  };

  /* ========================= üß∞ ÿÆÿµÿßÿ¶ÿµ ÿ•ÿØÿÆÿßŸÑ ŸÖÿπ ÿ™ÿ£ÿ´Ÿäÿ± ÿ™ÿ±ŸÉŸäÿ≤ ========================= */
  const inputProps = (name) => ({
    onFocus: () => setIsFocused(name),
    onBlur: () => setIsFocused(null),
    style: { ...styles.input, ...(isFocused === name ? styles.focused : {}) },
  });
  const selectProps = (name) => ({
    onFocus: () => setIsFocused(name),
    onBlur: () => setIsFocused(null),
    style: { ...styles.select, ...(isFocused === name ? styles.focused : {}) },
  });

  /* ========================= üñ•Ô∏è Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ========================= */
  return (
    <div style={styles.page}>
      <div style={styles.container}>
        <div style={styles.titleWrap}>
          <h2 style={styles.title}>üì¶ ÿ™ŸÇÿ±Ÿäÿ± ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ¥ÿ≠ŸÜÿßÿ™ - QCS</h2>
          <span style={styles.badge}>
            ÿ≠ŸÅÿ∏ ŸäÿØŸàŸä ŸÅŸÇÿ∑
            {saveMsg ? (
              <span style={{ marginInlineStart: 10, fontWeight: 800 }}>
                ¬∑ {saveMsg}
              </span>
            ) : null}
          </span>
        </div>

        {/* ÿßŸÑÿ™ÿ±ŸàŸäÿ≥ÿ© ŸÉÿ¨ÿØŸàŸÑ ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ™ÿπÿØŸäŸÑ */}
        <div style={styles.headerWrap}>
          <table style={styles.headerTable}>
            <colgroup>
              <col />
              <col />
              <col style={styles.headerRowSpacer} />
              <col />
              <col />
            </colgroup>
            <tbody>
              <tr>
                <th style={styles.headerTh}>Document Title</th>
                <td style={styles.headerTd}>
                  <input
                    {...inputProps("documentTitle")}
                    value={docMeta.documentTitle}
                    onChange={(e) =>
                      setDocMeta({ ...docMeta, documentTitle: e.target.value })
                    }
                  />
                </td>
                <td />
                <th style={styles.headerTh}>Document No</th>
                <td style={styles.headerTd}>
                  <input
                    {...inputProps("documentNo")}
                    value={docMeta.documentNo}
                    onChange={(e) =>
                      setDocMeta({ ...docMeta, documentNo: e.target.value })
                    }
                  />
                </td>
              </tr>
              <tr>
                <th style={styles.headerTh}>Issue Date</th>
                <td style={styles.headerTd}>
                  <input
                    type="date"
                    {...inputProps("issueDate")}
                    value={docMeta.issueDate}
                    onChange={(e) =>
                      setDocMeta({ ...docMeta, issueDate: e.target.value })
                    }
                  />
                </td>
                <td />
                <th style={styles.headerTh}>Revision No</th>
                <td style={styles.headerTd}>
                  <input
                    {...inputProps("revisionNo")}
                    value={docMeta.revisionNo}
                    onChange={(e) =>
                      setDocMeta({ ...docMeta, revisionNo: e.target.value })
                    }
                  />
                </td>
              </tr>
              <tr>
                <th style={styles.headerTh}>Area</th>
                <td style={styles.headerTd} colSpan={4}>
                  <input
                    {...inputProps("area")}
                    value={docMeta.area}
                    onChange={(e) =>
                      setDocMeta({ ...docMeta, area: e.target.value })
                    }
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        {/* ŸÜŸàÿπ ÿßŸÑÿ¥ÿ≠ŸÜÿ© */}
        <div style={styles.section}>
          <label style={styles.label}>üì¶ ŸÜŸàÿπ ÿßŸÑÿ¥ÿ≠ŸÜÿ© (Shipment Type):</label>
          <select
            value={shipmentType}
            onChange={(e) => setShipmentType(e.target.value)}
            {...selectProps("shipmentType")}
          >
            <option value="">-- ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ¥ÿ≠ŸÜÿ© --</option>
            <option value="LAMB AUS">LAMB AUS</option>
            <option value="MOUTTON AUS">MOUTTON AUS</option>
            <option value="LAMB S.A">LAMB S.A</option>
            <option value="MOUTTON S.A">MOUTTON S.A</option>
            <option value="VACUUM">VACUUM</option>
            <option value="FROZEN">FROZEN</option>
            <option value="PAK">PAK</option>
            <option value="KHZ">KHZ</option>
            <option value="IND MOUTTON">IND MOUTTON</option>
            <option value="IND VEAL">IND VEAL</option>
            <option value="FRESH LAMB">FRESH LAMB</option>
            <option value="FRSH CHICKEN">FRSH CHICKEN</option>
          </select>
        </div>

        {/* ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπÿßŸÖÿ© */}
        <fieldset style={styles.fieldset}>
          <legend style={styles.legend}>
            üìã ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπÿßŸÖÿ© ÿπŸÜ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± (General Information)
          </legend>
          <div style={styles.grid}>
            {[
              ["üìÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± (Report On)", "reportOn", "date"],
              ["üì• ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ (Sample Received On)", "receivedOn", "date"],
              ["üîç ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿ≠ÿµ (Inspection Date)", "inspectionDate", "date"],
              ["üå°Ô∏è ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ© (Temperature)", "temperature", "text"],
              ["üè∑Ô∏è ÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿäÿ© (Brand)", "brand", "text"],
              ["üßæ ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© (Invoice No)", "invoiceNo", "text"],
              ["üî¨ ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≠ŸÖŸàÿ∂ÿ© (PH)", "ph", "text"],
              ["üåç ÿ®ŸÑÿØ ÿßŸÑŸÖŸÜÿ¥ÿ£ (Origin)", "origin", "text"],
              ["üì¶ Air Way Bill No", "airwayBill", "text"],
              ["üì° Local Logger", "localLogger", "select"],
              ["üåê International Logger", "internationalLogger", "select"],
            ].map(([label, field, type]) => (
              <div key={field} style={styles.row}>
                <label>{label}:</label>
                {type === "select" ? (
                  <select
                    value={generalInfo[field]}
                    onChange={(e) => handleGeneralChange(field, e.target.value)}
                    {...selectProps(field)}
                  >
                    <option value="">-- ÿßÿÆÿ™ÿ± --</option>
                    <option value="YES">YES</option>
                    <option value="NO">NO</option>
                  </select>
                ) : type === "date" ? (
                  <input
                    type="date"
                    value={generalInfo[field]}
                    onChange={(e) => handleGeneralChange(field, e.target.value)}
                    {...inputProps(field)}
                  />
                ) : (
                  <input
                    value={generalInfo[field]}
                    onChange={(e) => handleGeneralChange(field, e.target.value)}
                    {...inputProps(field)}
                  />
                )}
              </div>
            ))}
          </div>

          {/* ÿ≠ÿßŸÑÿ© ÿßŸÑÿ¥ÿ≠ŸÜÿ© */}
          <div style={{ marginTop: "1rem" }}>
            <label style={styles.label}>‚ö†Ô∏è ÿ≠ÿßŸÑÿ© ÿßŸÑÿ¥ÿ≠ŸÜÿ© (Shipment Status):</label>
            <div style={styles.statusContainer}>
              <select
                value={shipmentStatus}
                onChange={(e) => setShipmentStatus(e.target.value)}
                {...selectProps("shipmentStatus")}
                style={{
                  ...selectProps("shipmentStatus").style,
                  fontWeight: 800,
                  color:
                    shipmentStatus === "ŸÖÿ±ÿ∂Ÿä"
                      ? "#16a34a"
                      : shipmentStatus === "Ÿàÿ≥ÿ∑"
                      ? "#d97706"
                      : "#dc2626",
                }}
              >
                <option value="ŸÖÿ±ÿ∂Ÿä">‚úÖ ŸÖÿ±ÿ∂Ÿä (Acceptable)</option>
                <option value="Ÿàÿ≥ÿ∑">‚ö†Ô∏è Ÿàÿ≥ÿ∑ (Average)</option>
                <option value="ÿ™ÿ≠ÿ™ ÿßŸÑŸàÿ≥ÿ∑">‚ùå ÿ™ÿ≠ÿ™ ÿßŸÑŸàÿ≥ÿ∑ (Below Average)</option>
              </select>
              <span
                style={{
                  fontWeight: 800,
                  color:
                    shipmentStatus === "ŸÖÿ±ÿ∂Ÿä"
                      ? "#16a34a"
                      : shipmentStatus === "Ÿàÿ≥ÿ∑"
                      ? "#d97706"
                      : "#dc2626",
                }}
              >
                {shipmentStatus === "ŸÖÿ±ÿ∂Ÿä"
                  ? "ŸÖŸÇÿ®ŸàŸÑ / Acceptable"
                  : shipmentStatus === "Ÿàÿ≥ÿ∑"
                  ? "ŸÖÿ™Ÿàÿ≥ÿ∑ / Average"
                  : "ÿ™ÿ≠ÿ™ ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑ / Below Average"}
              </span>
            </div>
          </div>
        </fieldset>

        {/* ÿπŸäŸÜÿßÿ™ ÿßŸÑŸÅÿ≠ÿµ */}
        <h4 style={styles.section}>üß™ ÿπŸäŸÜÿßÿ™ ÿßŸÑŸÅÿ≠ÿµ (Test Samples)</h4>
        <div style={styles.tableWrap}>
          <table style={styles.table}>
            <thead>
              <tr>
                <th style={styles.th}>#</th>
                <th style={styles.th}>Temp</th>
                <th style={styles.th}>PH</th>
                <th style={styles.th}>Slaughter Date</th>
                <th style={styles.th}>Expiry</th>
                <th style={styles.th}>Broken</th>
                <th style={styles.th}>Appearance</th>
                <th style={styles.th}>Blood Clots</th>
                <th style={styles.th}>Colour</th>
                <th style={styles.th}>Fat Discoloration</th>
                <th style={styles.th}>Meat Damage</th>
                <th style={styles.th}>Foreign Matter</th>
                <th style={styles.th}>Texture</th>
                <th style={styles.th}>Testicles</th>
                <th style={styles.th}>Smell</th>
              </tr>
            </thead>
            <tbody>
              {samples.map((sample, idx) => (
                <tr key={idx} style={{ textAlign: "center" }}>
                  <td style={styles.td}>{idx + 1}</td>
                  {Object.keys(sample).map((key) => (
                    <td key={key} style={styles.td}>
                      <input
                        value={sample[key]}
                        onChange={(e) =>
                          handleSampleChange(idx, key, e.target.value)
                        }
                        style={styles.tdInput}
                        onFocus={(e) => {
                          e.currentTarget.style.boxShadow =
                            "0 0 0 4px rgba(59,130,246,.20)";
                          e.currentTarget.style.borderColor = "#3b82f6";
                        }}
                        onBlur={(e) => {
                          e.currentTarget.style.boxShadow = "none";
                          e.currentTarget.style.borderColor = "#bfdbfe";
                        }}
                      />
                    </td>
                  ))}
                </tr>
              ))}
              <tr>
                <td
                  colSpan={15}
                  style={{ textAlign: "center", padding: "1rem" }}
                >
                  <button onClick={addSample} style={styles.addButton}>
                    ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿπŸäŸÜÿ© ÿ¨ÿØŸäÿØÿ© (Add Sample)
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        {/* ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ£ÿ≥ŸÅŸÑ ÿ¨ÿØŸàŸÑ ÿßŸÑÿπŸäŸÜÿßÿ™ */}
        <div style={{ marginTop: "12px" }}>
          <label style={styles.label}>üìù ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ (Notes):</label>
          <textarea
            value={notes}
            onChange={(e) => setNotes(e.target.value)}
            rows={4}
            placeholder="ÿßŸÉÿ™ÿ® ÿ£Ÿä ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸáŸÜÿß..."
            style={{
              ...styles.input,
              minHeight: "110px",
              resize: "vertical",
              lineHeight: "1.6",
            }}
          />
        </div>

        {/* ÿßŸÑŸÉŸÖŸäÿßÿ™ ŸàÿßŸÑÿ£Ÿàÿ≤ÿßŸÜ */}
        <div style={styles.formRow3}>
          <div>
            <label style={styles.label}>üì¶ ÿπÿØÿØ ÿßŸÑÿ≠ÿ®ÿßÿ™ ÿßŸÑŸÉŸÑŸä:</label>
            <input
              type="number"
              value={totalQuantity}
              onChange={(e) => setTotalQuantity(e.target.value)}
              placeholder="ŸÖÿ´ÿßŸÑ: 1000"
              {...inputProps("totalQuantity")}
            />
          </div>
          <div>
            <label style={styles.label}>‚öñÔ∏è Ÿàÿ≤ŸÜ ÿßŸÑÿ¥ÿ≠ŸÜÿ© ÿßŸÑŸÉŸÑŸä (ŸÉÿ¨ŸÖ):</label>
            <input
              type="number"
              value={totalWeight}
              onChange={(e) => setTotalWeight(e.target.value)}
              placeholder="ŸÖÿ´ÿßŸÑ: 750"
              {...inputProps("totalWeight")}
            />
          </div>
          <div>
            <label style={styles.label}>üî¢ ŸÖÿ™Ÿàÿ≥ÿ∑ Ÿàÿ≤ŸÜ ÿßŸÑÿ≠ÿ®ÿ© (ŸÉÿ¨ŸÖ):</label>
            <input
              type="text"
              value={averageWeight}
              disabled
              style={{
                ...styles.input,
                background: "#f3f4f6",
                color: "#111827",
              }}
            />
          </div>
        </div>

        {/* ÿ±ŸÅÿπ ÿ¥ŸáÿßÿØÿ© ÿßŸÑÿ≠ŸÑÿßŸÑ */}
        <div style={styles.section}>
          <button
            type="button"
            onClick={triggerFileSelect}
            style={styles.uploadButton}
          >
            üì§ ÿ•ÿ∂ÿßŸÅÿ© ÿ¥ŸáÿßÿØÿ© ÿßŸÑÿ≠ŸÑÿßŸÑ (Upload Halal Certificate)
          </button>
          <input
            type="file"
            accept="image/*,.pdf"
            ref={fileInputRef}
            onChange={handleCertificateUpload}
            style={{ display: "none" }}
          />
          {certificateName && <div>{certificateName}</div>}
          {certificateFile &&
            (String(certificateFile).startsWith("data:image/") ? (
              <img
                src={certificateFile}
                alt="Certificate Preview"
                style={styles.previewImage}
              />
            ) : (
              <div style={{ marginTop: 6, fontSize: 13, color: "#374151" }}>
                ‚úîÔ∏è ŸÖŸÑŸÅ PDF ŸÖÿ±ŸÅŸàÿπ (ÿ≥ŸäŸèÿ≠ŸÅÿ∏ Base64 ÿ∂ŸÖŸÜ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±)
              </div>
            ))}
        </div>

        {/* ÿßŸÑÿ™ŸàŸÇŸäÿπÿßÿ™ */}
        <div
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(260px, 1fr))",
            gap: "12px",
            marginTop: "0.75rem",
          }}
        >
          <div>
            <label style={styles.label}>
              üëÅÔ∏è ÿ™ŸÖ ÿßŸÑŸÅÿ≠ÿµ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© (Inspected By):
            </label>
            <input
              value={inspectedBy}
              onChange={(e) => setInspectedBy(e.target.value)}
              placeholder="ÿßÿ≥ŸÖ ŸÖŸÜ ŸÇÿßŸÖ ÿ®ÿßŸÑŸÅÿ≠ÿµ"
              {...inputProps("inspectedBy")}
            />
          </div>
          <div>
            <label style={styles.label}>
              üîç ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© (Verified By):
            </label>
            <input
              value={verifiedBy}
              onChange={(e) => setVerifiedBy(e.target.value)}
              placeholder="ÿßÿ≥ŸÖ ŸÖŸÜ ŸÇÿßŸÖ ÿ®ÿßŸÑÿ™ÿ≠ŸÇŸÇ"
              {...inputProps("verifiedBy")}
            />
          </div>
        </div>

        {/* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ≠ŸÅÿ∏/ÿßŸÑÿπÿ±ÿ∂ */}
        <div
          style={{
            marginTop: "1.25rem",
            display: "flex",
            gap: "10px",
            flexWrap: "wrap",
          }}
        >
          <button
            onClick={handleSave}
            style={{
              ...styles.saveButton,
              ...(isSaving ? styles.saveButtonDisabled : {}),
            }}
            disabled={isSaving}
            title={isSaving ? "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏..." : "ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±"}
          >
            {isSaving ? "‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏..." : "üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± (Save Report)"}
          </button>
          <button
            onClick={() => navigate("/qcs-raw-material-view")}
            style={styles.viewButton}
          >
            üìÑ ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± (View Reports)
          </button>
        </div>
      </div>

      {/* Toast ÿßŸÑÿ•ÿ¥ÿπÿßÿ±Ÿä ÿßŸÑÿ≥ŸÅŸÑŸä */}
      {toast.type && (
        <div style={styles.toastWrap}>
          <div
            role="alert"
            style={{
              ...styles.toast,
              background: toastColors(toast.type).bg,
              color: toastColors(toast.type).fg,
              borderColor: toastColors(toast.type).bd,
            }}
          >
            {toast.msg}
          </div>
        </div>
      )}
    </div>
  );
}
